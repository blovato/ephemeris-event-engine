name: Deploy to Fly.io

on:
  push:
    branches:
      - main

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  deploy:
    name: Deploy app
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20' # Specify Node.js version 20+ as per project requirements

      # --- Build Client (packages/web) ---
      - name: Install web dependencies
        run: npm install
        working-directory: packages/web
        
      - name: Build web application
        run: npm run build
        working-directory: packages/web
      
      # The 'out' directory is now created in packages/web/out
      # and will be available for the server to serve.
      # Fly.io's buildpack or Dockerfile for the server needs to be
      # configured to include this 'web/out' directory.

      # --- Install Server Dependencies ---
      - name: Install server dependencies
        run: npm install
        working-directory: packages/server

      - name: Deploy to Fly.io
        uses: superfly/flyctl-actions/setup-flyctl@master
      - run: flyctl deploy --remote-only --dockerfile packages/server/Dockerfile
        working-directory: .
